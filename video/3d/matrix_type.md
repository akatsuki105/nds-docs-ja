# 行列の型

基本的に、NDSのすべての行列は16の値(`m[0..15]`)からなる4x4行列です。

各要素は符号付き固定小数点32bitで、下位12bitに小数部があります。

他の行列型は、転送されるパラメータ数を減らすために使用されます。例えば、3x3マトリックスは9つのパラメータ(`m[0..8]`)しか必要とせず、他の7つの要素は自動的に0または1.0(`= 1 << 12`)に設定されます。

```
   _      4x4 Matrix       _        _    Identity Matrix    _
  | m[0]  m[1]  m[2]  m[3]  |      |  1.0   0     0     0    |
  | m[4]  m[5]  m[6]  m[7]  |      |  0     1.0   0     0    |
  | m[8]  m[9]  m[10] m[11] |      |  0     0     1.0   0    |
  |_m[12] m[13] m[14] m[15]_|      |_ 0     0     0     1.0 _|

   _      4x3 Matrix       _        _  Translation Matrix   _
  | m[0]  m[1]  m[2]   0    |      |  1.0   0     0     0    |
  | m[3]  m[4]  m[5]   0    |      |  0     1.0   0     0    |
  | m[6]  m[7]  m[8]   0    |      |  0     0     1.0   0    |
  |_m[9]  m[10] m[11]  1.0 _|      |_m[0]  m[1]  m[2]   1.0 _|

   _      3x3 Matrix       _        _     Scale Matrix      _
  | m[0]  m[1]  m[2]   0    |      | m[0]   0     0     0    |
  | m[3]  m[4]  m[5]   0    |      |  0    m[1]   0     0    |
  | m[6]  m[7]  m[8]   0    |      |  0     0    m[2]   0    |
  |_ 0     0     0     1.0 _|      |_ 0     0     0     1.0 _|
```

## 固定小数点

NDS は（浮動小数点数ではなく）固定小数点数を使用します。 

足し算と引き算は、分数部が同じbit数であれば通常の整数と同様に機能します。 分数部が同じで同じでない場合は、小数部のbit数が小さい方を左シフトで大きい方のbit数に合わせてから計算します。

掛け算の場合、結果の小数部は小数部の合計になります。つまり、12bitの小数部を持つ2つの数値を掛けると、24bitの小数部を持つ結果が得られるので、結果を右に12bitシフトする必要があります。

NDSの乗算ユニットは、次の式を処理する際に完全な24bitの小数部を維持しています。

```c
  cyx = ay1*b1x + ay2*b2x + ay3*b3x + ay4*b4x;
```

この3つの加算は、（上位ビットへのキャリーアウトを含む）完全な24bitの分数を使用しており、加算の最終結果は12bitだけ右にシフトされます。(つまり、計算途中で12bitへの切り捨てが起きることはありません)

除算の場合はその逆で、オペランドの小数部が減算され、`24bit÷12bit＝12bit` となります。 2つの12ビットの数値を除算する場合、除算の前に最初の数値を12で左シフトすると、12ビットの小数部を持つ結果が得られます。

